
<!DOCTYPE html>
<!--[if lt IE 9]><html class="lte-ie8" lang="en"><![endif]-->
<!--[if gt IE 8]><!--><html lang="en"><!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <title>GOV.UK - The best place to find government services and information</title>

    <!--[if gt IE 8]><!--><link href="/static/stylesheets/govuk-template.css?0.19.2" media="screen" rel="stylesheet" /><!--<![endif]-->
    <!--[if IE 6]><link href="/static/stylesheets/govuk-template-ie6.css?0.19.2" media="screen" rel="stylesheet" /><![endif]-->
    <!--[if IE 7]><link href="/static/stylesheets/govuk-template-ie7.css?0.19.2" media="screen" rel="stylesheet" /><![endif]-->
    <!--[if IE 8]><link href="/static/stylesheets/govuk-template-ie8.css?0.19.2" media="screen" rel="stylesheet" /><![endif]-->
    <!-- <link href="/static/stylesheets/govuk-template-print.css?0.19.2" media="print" rel="stylesheet" /> -->

    <!--[if IE 8]><link href="/static/stylesheets/fonts-ie8.css?0.19.2" media="all" rel="stylesheet" /><![endif]-->
    <!--[if gte IE 9]><!--><link href="/static/stylesheets/fonts.css?0.19.2" media="all" rel="stylesheet" /><!--<![endif]-->
    <!--[if lt IE 9]><script src="/static/javascripts/ie.js?0.19.2"></script><![endif]-->

    <link rel="shortcut icon" href="/static/images/favicon.ico?0.19.2" type="image/x-icon" />
    <link rel="mask-icon" href="/static/images/gov.uk_logotype_crown.svg?0.19.2" color="#0b0c0c" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/static/images/apple-touch-icon-152x152.png?0.19.2" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/static/images/apple-touch-icon-120x120.png?0.19.2" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/static/images/apple-touch-icon-76x76.png?0.19.2" />
    <link rel="apple-touch-icon-precomposed" href="/static/images/apple-touch-icon-60x60.png?0.19.2" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:image" content="/static/images/opengraph-image.png?0.19.2" />


    <meta name="viewport" content="width=100%, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0,target-densitydpi=device-dpi, user-scalable=no" />
    <link rel="stylesheet" type="text/css" href="/static/govuk_template-0.20.0/assets/stylesheets/govuk-elements.css" />
    <link rel="stylesheet" type="text/css" href="/static/stylesheets/application.css" />
    <link rel="stylesheet" type="text/css" href="/static/stylesheets/cms-v2.css" />


  </head>



  <body class="admin">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>


    <div id="global-header-bar"></div>

    <main id="content" role="main">

      <div class="breadcrumbs">
        <ol>
          <li><a href="/" data-event="breadcrumb-homepage">Admin</a></li>
        </ol>
      </div>

      <!-- CONTENT STARTS HERE -->

      <div class="grid-row">
        <div class="column-one-third">

          <div class="form-group">

            <label class="form-label" for="measure-type">Type of data</label>
            <select class="form-control" style="width: 100%" id="measure-type">
              <option value="" selected></option>
              <option value="percentage">Percentage</option>
              <option value="rate">Rate</option>
              <option value="number">Number</option>
              <option value="average-months">Average time (in months)</option>
              <!--<option value="other">Other</option>-->
            </select>

            <div id="include-number-option" class="checkbox-option hidden"><input type="checkbox" id="include-number" /><label for="include-number">Include number (numerator)</label></div>

            <div id="include-respondents-option" class="checkbox-option hidden"><input type="checkbox" id="include-respondents" /><label for="include-respondents">Include number of respondents</label></div>

            <div style="margin-top: 10px;">
              <label for="measure">Thing being measured <span class="form-hint">use lowercase (eg 'arrests')</span></label>
              <input type="text" class="form-control" id="measure" style="width: 100%;">
            </div>



          </div>


<!--           <fieldset>

            <legend class="radio-heading">Type</legend>

            <div class="">
              <input id="metric-1" type="radio" name="metric" value="Yes">
              <label for="metric-1" class="radio-label">Percentage</label>
            </div>

            <div class="">
              <input id="metric-4" type="radio" name="metric" value="No">
              <label for="metric-4" class="radio-label">Rate</label>
            </div>

            <div class="">
              <input id="metric-2" type="radio" name="metric" value="No">
              <label for="metric-2" class="radio-label">Amount of money</label>
            </div>

            <div class="">
              <input id="metric-3" type="radio" name="metric" value="No">
              <label for="metric-3" class="radio-label">Other number</label>
            </div>

          </fieldset> -->

          <div class="form-group">
            <label class="form-label">Ethnicity categories</label>
            <select class="form-control" style="width: 100%" id="ethnicity-categories">
              <option value="white-other">White, Other</option>
              <option value="white-british-other">White British, Other</option>
              <option selected value="5">Asian, Black, Mixed, White, Other</option>
              <option value="16">16 categories (2001 census)</option>
              <option value="18">18 categories (2011 census)</option>
              <option value="19">19 categories (school census)</option>
            </select>

            <div id="include-all-option" class="checkbox-option"><input type="checkbox" id="include-all" /><label for="include-all">Include ‘<span>All</span>’ aggregation</label></div>

            <div id="include-unknown-option" class="checkbox-option"><input type="checkbox" id="include-unknown" /><label for="include-unknown">Include ‘Unknown’ category</label></div>

          </div>

          <div class="form-group">
            <label class="form-label">Secondary dimension (optional)</label>
            <select class="form-control secondary-dimension" id="secondary-dimension">
              <option selected value="none"></option>
              <option value="calendar-years">Years (calendar)</option>
              <option value="financial-years">Years (financial)</option>
              <option value="financial-quarters">Financial quarters</option>
              <option value="gender">Gender</option>
              <option value="sex">Sex</option>
              <option value="regions">Region</option>
              <option value="local-authority">Local authority</option>
              <option value="police-force-area">Police force area</option>
              <option value="age-group">Age group</option>
              <option value="social-economic">Social-economic status</option>
              <option value="weekly-income">Weekly income</option>
              <option value="free-school-meal-eligibility">Free school meal eligibility</option>
              <option value="other">Other:</option>
            </select>


            <input id="secondary-dimension-name" type="text" class="form-control hidden" style="width: 60%;margin-top:5px; vertical-align: top; margin-top: -2px; margin-left: 5px; margin-bottom: -2px;" />

            <div id="include-all-secondary-option" class="checkbox-option js-hidden"><input type="checkbox" id="include-all-secondary" /><label for="include-all-secondary">Include ‘All’ aggregation</label></div>

          </div>


          <div class="form-group hidden" id="range-selectors">
            <div style="display: table; width: 100%;">
              <div style="display: table-cell; width: 50%; padding-right: 5px;">
                <label class="form-label" for="from">From</label>
                <select class="form-control" id="from" style="width: 100%;">
                </select>
              </div>
              <div style="display: table-cell; width: 50%; padding-left: 5px;">
                <label class="form-label" for="to">To</label>
                <select class="form-control" id="to" style="width: 100%;">
                </select>
              </div>
            </div>

          </div>

          <div class="form-group hidden" id="other-secondary-dimensions">

            <fieldset>
              <legend>Other Categories</legend>

              <div>
                <input id="secondary-dimension-1" type="text" class="form-control" style="width: 100%;" />
              </div>
              <div>
                <input id="secondary-dimension-2" type="text" class="form-control" style="width: 100%;" />
              </div>
              <div>
                <input id="secondary-dimension-3" type="text" class="form-control" style="width: 100%;" />
              </div>
              <div>
                <input id="secondary-dimension-4" type="text" class="form-control hidden" style="width: 100%;" />
              </div>
              <div>
                <input id="secondary-dimension-5" type="text" class="form-control hidden" style="width: 100%;" />
              </div>
            </fieldset>

          </div>


        </div>
        <div class="column-two-thirds">

          <div id="warning" class="hidden">Warning: Too many columns and rows</div>

          <table class="editable-table" id="editable-table">
            <legend id="legend"></legend>
            <thead>
              <tr>
                <th scope="col">Ethnicity</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th>All</th>
                <td><input type="text" autofocus></td>
              </tr>
              <tr>
                <th>Asian</th>
                <td><input type="text"></td>
              </tr>
              <tr>
                <th>Black</th>
                <td><input type="text"></td>
              </tr>
              <tr>
                <th>Mixed</th>
                <td><input type="text"></td>
              </tr>
              <tr>
                <th>White</th>
                <td><input type="text"></td>
              </tr>
              <tr>
                <th>Other</th>
                <td><input type="text"></td>
              </tr>
            </tbody>
          </table>


          <div style="margin-top: 50px;"><button type="submit" class="button">Save</button></div>
        </div>
      </div>

      <script>

        var ethnicityCategoriesSelect = document.getElementById('ethnicity-categories')
        var secondaryDimensionsSelect = document.getElementById('secondary-dimension')
        var editableTable = document.getElementById('editable-table')
        var rangeSelectors = document.getElementById('range-selectors')
        var fromSelector = document.getElementById('from')
        var toSelector = document.getElementById('to')
        var warningElement = document.getElementById('warning')
        var measureElement = document.getElementById('measure')
        var measureTypeElement = document.getElementById('measure-type')

        var includeNumberCheckbox = document.getElementById('include-number')
        var includeRespondentsCheckbox = document.getElementById('include-respondents')
        var includeNumberOption = document.getElementById('include-number-option')
        var includeRespondentsOption = document.getElementById('include-respondents-option')

        var includeAllCheckbox = document.getElementById('include-all')
        var includeUnknownCheckbox = document.getElementById('include-unknown')

        var includeAllSecondaryOption = document.getElementById('include-all-secondary-option')
        var includeAllSecondaryCheckbox = document.getElementById('include-all-secondary')

        var otherSecondaryDimensionsElement = document.getElementById('other-secondary-dimensions')

        var secondaryDimensionNameElement = document.getElementById('secondary-dimension-name')

        var otherDimension1Element = document.getElementById('secondary-dimension-1')
        var otherDimension2Element = document.getElementById('secondary-dimension-2')
        var otherDimension3Element = document.getElementById('secondary-dimension-3')
        var otherDimension4Element = document.getElementById('secondary-dimension-4')
        var otherDimension5Element = document.getElementById('secondary-dimension-5')

        var ethnicityCategories = {
          "white-other": ["White", "Other"],
          "white-british-other": ["White British", "Other"],
          "5": ["Asian", "Black", "Mixed", "White", "Other"],
          "16": [
            {"label": "Asian", "broad": true},
            {"label": "Bangladeshi", "broad": false},
            {"label": "Chinese", "broad": false},
            {"label": "Indian", "broad": false},
            {"label": "Pakistani", "broad": false},
            {"label": "Asian other", "broad": false},
            {"label": "Black", "broad": true},
            {"label": "Black African", "broad": false},
            {"label": "Black Caribbean", "broad": false},
            {"label": "Black other", "broad": false},
            {"label": "Mixed", "broad": true},
            {"label": "Mixed White and Asian", "broad": false},
            {"label": "Mixed White and Black African", "broad": false},
            {"label": "Mixed White and Black Caribbean", "broad": false},
            {"label": "Any other mixed/multiple ethnic background", "broad": false},
            {"label": "White", "broad": true},
            {"label": "White British", "broad": false},
            {"label": "White Irish", "broad": false},
            {"label": "White other", "broad": false},
            {"label": "Other", "broad": true},
            {"label": "Any other", "broad": false}
          ],
          "18": [
            {"label": "Asian", "broad": true},
            {"label": "Bangladeshi", "broad": false},
            {"label": "Chinese", "broad": false},
            {"label": "Indian", "broad": false},
            {"label": "Pakistani", "broad": false},
            {"label": "Asian other", "broad": false},
            {"label": "Black", "broad": true},
            {"label": "Black African", "broad": false},
            {"label": "Black Caribbean", "broad": false},
            {"label": "Black other", "broad": false},
            {"label": "Mixed", "broad": true},
            {"label": "Mixed White and Asian", "broad": false},
            {"label": "Mixed White and Black African", "broad": false},
            {"label": "Mixed White and Black Caribbean", "broad": false},
            {"label": "Mixed other", "broad": false},
            {"label": "White", "broad": true},
            {"label": "White British", "broad": false},
            {"label": "White Irish", "broad": false},
            {"label": "White Gypsy/Traveller", "broad": false},
            {"label": "White other", "broad": false},
            {"label": "Other", "broad": true},
            {"label": "Arab", "broad": false},
            {"label": "Any other", "broad": false}
          ],
          "19": [
            {"label": "Asian", "broad": true},
            {"label": "Bangladeshi", "broad": false},
            {"label": "Indian", "broad": false},
            {"label": "Pakistani", "broad": false},
            {"label": "Asian other", "broad": false},
            {"label": "Black", "broad": true},
            {"label": "Black African", "broad": false},
            {"label": "Black Caribbean", "broad": false},
            {"label": "Black other", "broad": false},
            {"label": "Chinese", "broad": true},
            {"label": "Mixed", "broad": true},
            {"label": "Mixed White and Asian", "broad": false},
            {"label": "Mixed White and Black African", "broad": false},
            {"label": "Mixed White and Black Caribbean", "broad": false},
            {"label": "Mixed other", "broad": false},
            {"label": "White", "broad": true},
            {"label": "White British", "broad": false},
            {"label": "White Irish", "broad": false},
            {"label": "White Irish Traveller", "broad": false},
            {"label": "White Gypsy/Roma", "broad": false},
            {"label": "White other", "broad": false},
            {"label": "Other", "broad": true}
          ]
        }

        var secondaryDimensions = {
          "none": {
            "categories": [""],
            "range": false
          },
          "calendar-years": {
            "label": "Year",
            "title_fragment": "over time",
            "categories": ["2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017"],
            "range": true
          },
          "financial-years": {
            "label": "Year",
            "title_fragment": "over time",
            "categories": ["2009/10", "2010/11", "2011/12", "2012/13", "2013/14", "2014/15", "2015/16", "2016/17"],
            "range": true
          },
          "financial-quarters": {
            "label": "Quarter",
            "title_fragment": "over time",
            "categories": ["Jan-Mar 2014", "Apr-Jun 2014", "Jul-Sep 2014", "Oct-Dec 2014", "Jan-Mar 2015", "Apr-Jun 2015"],
            "range": true
          },
          "gender": {
            "label": "Gender",
            "title_fragment": "and gender",
            "categories": ["Men", "Women"],
            "range": false
          },
          "sex": {
            "label": "Sex",
            "title_fragment": "and sex",
            "categories": ["Men", "Women"],
            "range": false
          },
          "regions": {
            "label": "Region",
            "title_fragment": "and region",
            "categories": ["North East", "North West", "Yorkshire and the Humber", "East Midlands", "West Midlands", "East", "London", "South East", "South West"],
            "range": false
          },
          "police-force-area": {
            "label": "Police force area",
            "title_fragment": "and police force area",
            "categories": ["Avon & Somerset", "Bedfordshire", "British Transport Police", "Cambridgeshire", "Cheshire", "Cleveland", "Cumbria", "Derbyshire", "Devon & Cornwall", "Dorset", "Durham", "Dyfed-Powys", "Essex", "Gloucestershire", "Greater Manchester", "Gwent", "Hampshire", "Hertfordshire", "Humberside", "Kent", "Lancashire", "Leicestershire", "Lincolnshire", "London, City of", "Merseyside", "Metropolitan Police", "Norfolk", "North Wales", "North Yorkshire", "Northamptonshire", "Northumbria", "Nottinghamshire", "South Wales", "South Yorkshire", "Staffordshire", "Suffolk", "Surrey", "Sussex", "Thames Valley", "Warwickshire", "West Mercia", "West Midlands", "West Yorkshire"],
            "range": false
          },
          "local-authority": {
            "label": "Local authority",
            "title_fragment": "and local authority",
            "categories": ["Barking and Dagenham", "Barnet", "Barnsley", "Bath and North East Somerset", "Bedford", "Bexley", "Birmingham", "Blackburn with Darwen", "Blackpool", "Bolton", "Bournemouth", "Bracknell Forest", "Bradford", "Brent", "Brighton and Hove", "Bristol, City of", "..."],
            "range": false
          },
          "age-group": {
            "label": "Age group",
            "title_fragment": "and age group",
            "categories": ["16-19", "20-29", "30-39", "40-49", "50-59", "60-64", "65+"],
            "range": false
          },
          "social-economic": {
            "label": "Social-economic status",
            "title_fragment": "and social-economic status",
            "categories": ["Higher managerial, administrative and professional occupations", "Intermediate occupations", "Routine and manual operations", "Never worked and long-term unemployed", "Full time students"],
            "range": false
          },
          "weekly-income": {
            "label": "Weekly income",
            "title_fragment": "and weekly household income",
            "categories": ["Up to £99", "£100 to £199", "£200 to £299", "£300 to £399", "£400 to £499", "£500 to £599", "£600 to £699", "£700 to £799", "£800 to £899", "£900 to £999"],
            "range": true
          },
          "free-school-meal-eligibility": {
            "label": "Free school meal eligibility",
            "title_fragment": "and free school meal eligibility",
            "categories": ["Eligible", "Not eligible"],
            "range": false
          }
        }

        function updateTableName() {

          var secondaryDimension = secondaryDimensions[secondaryDimensionsSelect.value]
          var title = '';

          switch (measureTypeElement.value) {
            case 'percentage':
              title += 'Percentage ';

              if (includeNumberCheckbox.checked) {
                title += 'and number '
              }

              title += 'of '

              break;
            case 'rate':
              title += 'Rate of '; break;
            case 'average-months':
              title += 'Average time (in years and months) '; break;
            case 'number':
              title += 'Number of '; break;
          }

          if (measureElement.value != '') {
            title += measureElement.value + ' '
          } else {
            title += '[...] '
          }


          title += 'by ethnicity '

          if (secondaryDimension && secondaryDimension.title_fragment) {
            title += secondaryDimension.title_fragment;
          }

          if (secondaryDimensionsSelect.value == 'other') {

            title += ' and '

            if (secondaryDimensionNameElement.value != '') {
              title += secondaryDimensionNameElement.value
            } else {
              title += '[...]'
            }

          }

          legend.textContent = title

        }

        function updateCheckboxes() {

          switch (measureTypeElement.value) {

            case 'percentage':
              includeNumberOption.classList.remove('hidden')
              includeRespondentsOption.classList.remove('hidden')
              break;
            case 'rate':
              includeNumberOption.classList.remove('hidden')
              includeRespondentsOption.classList.add('hidden')
              includeRespondentsCheckbox.checked = false
              break;
            default:
              includeNumberOption.classList.add('hidden')
              includeNumberCheckbox.checked = false
              includeRespondentsOption.classList.add('hidden')
              includeRespondentsCheckbox.checked = false

          }

        }

        function secondaryDimensionChanged() {

          updateTableName();


          if (secondaryDimensionsSelect.value != 'other') {

          var secondaryDimension = secondaryDimensions[secondaryDimensionsSelect.value]

          if (secondaryDimension.range) {
            rangeSelectors.classList.remove('hidden')


            fromSelector.innerHTML = ''
            toSelector.innerHTML = ''

            for (var i = 0; i < secondaryDimension.categories.length; i++) {
              var category = secondaryDimension.categories[i]

              var option = document.createElement('option')
              option.value = category
              option.textContent  = category

              toOption = option.cloneNode(true)

              if (i == 0) {
                option.setAttribute('selected', true)
              }

              if (i + 1 == secondaryDimension.categories.length) {
                toOption.setAttribute('selected', true)
              }

              fromSelector.appendChild(option)
              toSelector.appendChild(toOption)
            }


            includeAllSecondaryOption.classList.add('js-hidden')
            includeAllCheckbox.checked = false

          } else {
            rangeSelectors.classList.add('hidden')

            includeAllSecondaryOption.classList.remove('js-hidden')


          }

          secondaryDimensionsSelect.classList.remove('other')
          otherSecondaryDimensionsElement.classList.add('hidden')
          secondaryDimensionNameElement.classList.add('hidden')

          } else {

            rangeSelectors.classList.add('hidden')
            secondaryDimensionsSelect.classList.add('other')
            secondaryDimensionNameElement.classList.remove('hidden')
            otherSecondaryDimensionsElement.classList.remove('hidden')
          }

        }

        function updateOtherInputs() {


          if (otherDimension3Element.value != '' || otherDimension4Element.value != '') {
            otherDimension4Element.classList.remove('hidden')
          } else {
            otherDimension4Element.classList.add('hidden')
          }

          if (otherDimension4Element.value != '' || otherDimension5Element.value != '') {
            otherDimension5Element.classList.remove('hidden')
          } else {
            otherDimension5Element.classList.add('hidden')
          }


        }


        function updateTable() {

          updateTableName();
          updateCheckboxes();

          updateOtherInputs();

          var categories = Object.assign([], ethnicityCategories[ethnicityCategoriesSelect.value])


          var secondaryDimension;

          if (secondaryDimensionsSelect.value != 'other') {

            secondaryDimension = Object.assign({}, secondaryDimensions[secondaryDimensionsSelect.value])

          } else {

            var otherCategories = [
              otherDimension1Element.value,
              otherDimension2Element.value,
              otherDimension3Element.value,
              otherDimension4Element.value,
              otherDimension5Element.value
            ].filter(function(value) {
              return (value != '')
            })


            secondaryDimension =  {
              "label": "Test",
              "title_fragment": "and test",
              "categories": otherCategories
            }

          }

          var thirdDimensions = []

          if (includeAllSecondaryCheckbox.checked) {
            secondaryDimension.categories = Object.assign([], secondaryDimension.categories)
            secondaryDimension.categories.unshift('All')
          }

          if (includeUnknownCheckbox.checked) {

            if (typeof categories[0] == 'string') {
              categories.push('Unknown')
            } else {
              categories.push({"label": 'Unknown', "broad": true})
            }
          }

          if (includeAllCheckbox.checked) {

            if (typeof categories[0] == 'string') {
              categories.unshift('All')
            } else {
              categories.unshift({"label": 'All', "broad": true})
            }
          }

          switch (measureTypeElement.value) {

            case 'percentage':
              thirdDimensions.push('%'); break;
            case 'rate':
              thirdDimensions.push('Rate'); break;
            case 'number':
              thirdDimensions.push('Number'); break;
            default:
              thirdDimensions.push(measureTypeElement.value); break;
          }

          if (includeNumberCheckbox.checked) {
            thirdDimensions.push('Number')
          }

          if (includeRespondentsCheckbox.checked) {
            thirdDimensions.push('Survey respondents')
          }

          var secondaryDimensionCategories

          if (secondaryDimension.range) {

            var fromIndex = secondaryDimension.categories.indexOf(fromSelector.value)
            var toIndex = secondaryDimension.categories.indexOf(toSelector.value)

            secondaryDimensionCategories = secondaryDimension.categories.slice(fromIndex, toIndex + 1)

          } else {
            secondaryDimensionCategories = secondaryDimension.categories
          }


          if (categories.length > 9 && (secondaryDimensionCategories.length * thirdDimensions.length) > 9) {
            warningElement.classList.remove('hidden')
          } else {
            warningElement.classList.add('hidden')
          }

          var thead = document.createElement('thead');
          var tbody = document.createElement('tbody')


          // Ethnicities in ROWS
          if (categories.length > 5 || secondaryDimensionCategories.length < 7) {

            var theadRow = document.createElement('tr')

            var firstHeader = document.createElement('th')
            firstHeader.textContent = 'Ethnicity'
            firstHeader.setAttribute('scope', 'col')

            if (secondaryDimensionsSelect.value != 'none' && thirdDimensions.length > 1) {
              firstHeader.setAttribute('rowspan', 2)
            }

            theadRow.appendChild(firstHeader)

            if (secondaryDimensionsSelect.value == 'none') {

              switch (measureTypeElement.value) {
                case 'percentage':
                  secondaryDimensionCategories = ['Percentage'];
                  break;
                case 'rate':
                  secondaryDimensionCategories = ['Rate']; break;
                case 'number':
                  secondaryDimensionCategories = ['Number']; break;
                case 'average-months':
                  secondaryDimensionCategories = ['Time']; break;
                case 'other':
                  secondaryDimensionCategories = [measureElement.value]; break;
              }


              if (measureTypeElement.value == 'percentage' || measureTypeElement.value == 'rate') {

                if (includeNumberCheckbox.checked) {
                  secondaryDimensionCategories.push('Number')
                }

                if (includeRespondentsCheckbox.checked) {
                 secondaryDimensionCategories.push('Survey respondents')
                }

              }

            }

            for (x of secondaryDimensionCategories) {
              var header = document.createElement('th')
              header.textContent = x

              if (secondaryDimensionsSelect.value != 'none' && thirdDimensions.length > 1) {
                header.setAttribute('colspan', thirdDimensions.length)
              }

              theadRow.appendChild(header)
            }

            thead.appendChild(theadRow)

            if (secondaryDimensionsSelect.value != 'none' && thirdDimensions.length > 1) {

              var theadRow = document.createElement('tr')

              for (secondaryCategory of secondaryDimensionCategories) {

                for (thirdCategory of thirdDimensions) {

                  var header = document.createElement('th')
                  header.textContent = thirdCategory
                  header.classList.add('secondary')
                  theadRow.appendChild(header)
                }
              }

              thead.appendChild(theadRow)
            }

            for (category of categories) {

              var row = document.createElement('tr')
              var header = document.createElement('th')

              if (typeof category === 'string') {
                header.textContent = category
              } else if (typeof category === 'object') {
                header.textContent = category.label

                if (category.broad) {
                  header.classList.add('broad')
                } else {
                  header.classList.add('specific')
                }
              }


              row.appendChild(header)

              for (x of secondaryDimensionCategories) {

                if (secondaryDimensionsSelect.value == 'none') {
                  thirdDimensions = ['x']
                }

                for (_ of thirdDimensions) {

                  var input = document.createElement('input')
                  input.setAttribute('type', 'text')
                  var cell = document.createElement('td')
                  cell.appendChild(input)
                  row.appendChild(cell)

                }
              }
              tbody.appendChild(row)
            }


          // Ethnicities in columns
          } else {

            var theadRow = document.createElement('tr')

            var firstHeader = document.createElement('th')
            firstHeader.textContent = secondaryDimension.label
            firstHeader.setAttribute('scope', 'col')
            firstHeader.setAttribute('rowspan', thirdDimensions.length)


            theadRow.appendChild(firstHeader)

            for (category of categories) {
              var header = document.createElement('th')
              header.setAttribute('colspan', thirdDimensions.length)
              header.textContent = category
              theadRow.appendChild(header)
            }
            thead.appendChild(theadRow)

            if (thirdDimensions.length > 1) {

              var tr = document.createElement('tr')

              for (category of categories) {
                for (thirdDimension of thirdDimensions) {
                  var header = document.createElement('th')
                  header.textContent = thirdDimension
                  header.classList.add('secondary')
                  tr.appendChild(header)
                }
              }


              thead.appendChild(tr)
            }


            for (dimension of secondaryDimensionCategories) {

              var row = document.createElement('tr')
              var header = document.createElement('th')
              header.textContent = dimension;

              row.appendChild(header)

              for (x of categories) {


                for (_ of thirdDimensions) {

                  var input = document.createElement('input')
                  input.setAttribute('type', 'text')
                  var cell = document.createElement('td')
                  cell.appendChild(input)
                  row.appendChild(cell)

                }


              }
              tbody.appendChild(row)
            }

          }

          var existingThead = editableTable.getElementsByTagName('thead')[0]
          editableTable.removeChild(existingThead)
          editableTable.appendChild(thead)

          var existingTbody = editableTable.getElementsByTagName('tbody')[0]
          editableTable.removeChild(existingTbody)
          editableTable.appendChild(tbody)

        }


        measureElement.addEventListener('change', updateTableName)
        secondaryDimensionNameElement.addEventListener('change', updateTableName)

        secondaryDimensionsSelect.addEventListener('change', secondaryDimensionChanged)
        ethnicityCategoriesSelect.addEventListener('change', updateTable)
        secondaryDimensionsSelect.addEventListener('change', updateTable)
        measureTypeElement.addEventListener('change', updateTable)

        fromSelector.addEventListener('change', updateTable)
        toSelector.addEventListener('change', updateTable)
        includeNumberCheckbox.addEventListener('change', updateTable)
        includeRespondentsCheckbox.addEventListener('change', updateTable)
        includeAllCheckbox.addEventListener('change', updateTable)
        includeUnknownCheckbox.addEventListener('change', updateTable)

        otherDimension1Element.addEventListener('change', updateTable)
        otherDimension2Element.addEventListener('change', updateTable)
        otherDimension3Element.addEventListener('change', updateTable)
        otherDimension4Element.addEventListener('change', updateTable)
        otherDimension5Element.addEventListener('change', updateTable)

        includeAllSecondaryCheckbox.addEventListener('change', updateTable)

      </script>



      <script>

        function handleTablePaste(event) {

          var input = event.target
          var clipboardData = event.clipboardData

          if (clipboardData.types.indexOf('text/plain') != -1) {

            var pastedData = clipboardData.getData('text/plain')

            var tabularDataRegex = new RegExp('.+')

            var inputs = document.getElementById('editable-table').querySelectorAll('input')

            var currentCell = input.parentElement;
            var currentRow = currentCell.parentElement

            var currentX = Array.prototype.slice.call(currentRow.children).indexOf(currentCell) - 1
            var currentY = Array.prototype.slice.call(currentRow.parentElement.children).indexOf(currentCell.parentElement)


            var cellsInRow = currentRow.children.length - 1


            if (pastedData.match(tabularDataRegex)) {

              var rows = pastedData.split(/\n/)

              for (var x = 0; x < rows.length; x++) {
                var row = rows[x]

                var cells = row.split(/\s/)

                for (var y = 0; y < cells.length; y++) {
                  var cell = cells[y]

                  var cellIndex = y + (x * cellsInRow) + currentX + (currentY * cellsInRow);

                  if (inputs.length > cellIndex) {
                    inputs[cellIndex].value = cell
                  }

                }
              }

              event.stopPropagation();
              event.preventDefault();
              return false

            }


          }


        }


        document.getElementById('editable-table').addEventListener('paste', handleTablePaste)


        function cellBlurred(event) {

          if (event.target.tagName === 'INPUT') {


            var currentCell = event.target.parentElement;
            var currentRow = currentCell.parentElement

            var currentX = Array.prototype.slice.call(currentRow.children).indexOf(currentCell) - 1


            var valueTypes = [measureTypeElement.value];

            if (includeNumberCheckbox.checked) {
              valueTypes.push('number')
            }

            if (includeRespondentsCheckbox.checked) {
              valueTypes.push('number')
            }

            var currentValueType;

            if (currentX + 1 > valueTypes.length) {
              currentValueType = valueTypes[0]
            } else {
              currentValueType = valueTypes[currentX]
            }


            var inputValue = event.target.value;

            if (inputValue != '') {

              event.target.setAttribute('data-raw', inputValue)
              event.target.value = formatValue(inputValue, currentValueType)
            }

          }

        }

        function cellFocused(event) {

          if (event.target.tagName === 'INPUT') {

            var rawData = event.target.getAttribute('data-raw')
            if (rawData) {
              event.target.value = rawData
            }
          }

        }

        document.getElementById('editable-table').addEventListener('focusout', cellBlurred)
        document.getElementById('editable-table').addEventListener('focusin', cellFocused)


        function cellKeyPressed(event) {

          if (event.target.tagName === 'INPUT') {

            var cell = event.target.parentElement;

            var tableRow = cell.parentElement;
            var tableBody = tableRow.parentElement
            var allCells = tableBody.getElementsByTagName('td')

            var cellsInRowCount = tableRow.children.length - 1

            var currentX = Array.prototype.slice.call(tableRow.children).indexOf(cell) - 1
            var currentIndex = Array.prototype.slice.call(allCells).indexOf(cell)

            switch (event.key) {

              case 'ArrowLeft':

                if (currentIndex > 0) {
                  allCells[currentIndex - 1].querySelector('input').focus()
                }

                break;

              case 'ArrowRight', 'Enter':

                if (currentIndex < allCells.length) {
                  allCells[currentIndex + 1].querySelector('input').focus()
                }
                break;

              case 'ArrowDown':

                if ((currentIndex + cellsInRowCount) < allCells.length) {
                  allCells[currentIndex + cellsInRowCount].querySelector('input').focus()
                }

                break;

              case 'ArrowUp':

                if ((currentIndex - cellsInRowCount) >= 0) {

                  allCells[currentIndex - cellsInRowCount].querySelector('input').focus()
                }

                break;

            }

          }

        }



        document.getElementById('editable-table').addEventListener('keydown', cellKeyPressed)


        function formatValue(value, format) {

          var formatted = '';

          switch (format) {
            case 'percentage':

              var fractionDigits = 1; // TODO: set to zero if all values are integers

              formatted = parseFloat(value).toLocaleString('en', {'useGrouping': false, 'minimumFractionDigits': fractionDigits, 'maximumFractionDigits': fractionDigits});
              break;

            case 'number':
              formatted = parseFloat(value).toLocaleString('en', {'useGrouping': true});
              break;
            case 'average-months':

              var value = parseInt(value)
              var years = Math.floor(value / 12)
              var months = value % 12

              if (years > 1) {
                formatted = years + ' years and '
              } else if (years == 1) {
                formatted = '1 year and '
              }


              formatted += months + ' months';
              break;
            default:
              formatted = value

          }

          return formatted
        }
      </script>

      <style>

        .editable-table {
          width: 100%;
        }


        .editable-table td,
        .editable-table th {
          border-collapse: collapse;
          border-width: 1px;
          border-style: solid;
          border-top-color: #bfc1c3;
          border-bottom-color: #bfc1c3;
          border-left-color: transparent;
          border-right-color: lightgrey;
          vertical-align: top;
          padding: 0;
          line-height: 20px;
          width: auto;
        }

        .editable-table thead th {
          border-top-color: transparent;
        }

        .editable-table thead th.secondary {
          font-weight: normal;
        }

        .editable-table thead th[scope="col"] {
          text-align: left;
        }

        .editable-table tbody th {
          min-width: 150px;
          font-weight: normal;
        }

        .editable-table th {
          text-align: right;
          padding-right: 5px;
          padding-top: 5px;
          padding-bottom: 5px;
        }

        .editable-table tbody tr th:first-child {
          text-align: left;
        }

        .editable-table tbody th.broad {
          font-weight: bold;
        }

        .editable-table tbody th.specific {
          padding-left: 15px;
        }


        .editable-table tr th:last-child,
        .editable-table tr td:last-child {
          border-right-color: transparent;
          padding-right: 0;
        }

        .editable-table input,
        .editable-table span.value {
          border: 0;
          margin: 0;
          display: block;
          width: 100%;
          padding: 5px;
          box-sizing: border-box;
          text-align: right;
        }

        #warning {
          color: #B10E1E;
          text-align: center;
          margin-bottom: 1em;
          font-size: 16px;
        }

        #legend {
          font-weight: bold;
          margin-bottom: 1em;
        }

        .checkbox-option {
          margin-top: 5px;
        }

        .checkbox-option label {
          margin-left: 5px;
        }

        select.secondary-dimension {
          width: 100%;
        }

        select.secondary-dimension.other {
          width: 30%;
        }

      </style>

      <!-- CONTENT ENDS HERE -->
    </main>
    <footer class="group js-footer" id="footer" role="contentinfo">

      <div class="footer-wrapper">

        <div class='footer-categories grid-row'>
          <div class='column-one-third'>
            <h2>Contact</h2>
            <ul>
              <li>
                  <a href="mailto:ethnicity@cabinetoffice.gov.uk">ethnicity@cabinetoffice.gov.uk</a>
              </li>
              <li>
                  <a href="/">Site preview</a>
              </li>
              <li>
                  <a href="/cms/">CMS</a>
              </li>
              <li>
                  <a href="/prototype/">Prototype</a>
              </li>
            </ul>
          </div>
        </div>
        <div class="footer-meta">
          <div class="footer-meta-inner">
            <div class="open-government-licence">
              <p class="logo"><a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence</a></p>
                <p>All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence v3.0</a>, except where otherwise stated</p>
            </div>
          </div>
          <div class="copyright">
            <a href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/copyright-and-re-use/crown-copyright/">&copy; Crown copyright</a>
          </div>
        </div>
      </div>
    </footer>

    <div id="global-app-error" class="app-error hidden"></div>
    <script src="/static/javascripts/govuk-template.js?0.19.2"></script>
    <script type="text/javascript" src="/static/vendor/jquery.min.js"></script>
    <script type="text/javascript" src="/static/javascripts/all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/5.0.11/highcharts.js"></script>
    <script type="text/javascript" src="/static/vendor/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="/static/vendor/underscore-min.js"></script>
    <script src="/static/javascripts/rd-data-tools.js"></script>
    <script src="/static/javascripts/rd-graph.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/5.0.11/modules/exporting.js"></script>
    </script>
    <script>if (typeof window.GOVUK === 'undefined') document.body.className = document.body.className.replace('js-enabled', '');</script>
  </body>
</html>